<div class="container mt-4">
  <h3 class="mb-4">Mis Formularios</h3>

  <div *ngIf="formularios.length === 0" class="alert alert-info">
    No tienes formularios registrados.
  </div>

  <button
    class="btn btn-outline-primary mb-3"
    type="button"
    data-bs-toggle="collapse"
    data-bs-target="#crearFormularioCollapse"
  >
    Nuevo Formulario
  </button>

  <div class="collapse mb-4" id="crearFormularioCollapse">
    <div class="card card-body">
      <form (ngSubmit)="crearFormulario()" #formularioForm="ngForm">
        <div class="mb-3">
          <label for="nombre" class="form-label">Nombre</label>
          <input
            id="nombre"
            type="text"
            class="form-control"
            [(ngModel)]="nuevoFormulario.nombre"
            name="nombre"
            required
          />
        </div>

        <div class="mb-3">
          <label for="descripcion" class="form-label">Descripción</label>
          <input
            id="descripcion"
            type="text"
            class="form-control"
            [(ngModel)]="nuevoFormulario.descripcion"
            name="descripcion"
            required
          />
        </div>

        <button
          class="btn btn-primary"
          type="submit"
          [disabled]="!formularioForm.valid"
        >
          Crear
        </button>
      </form>
    </div>
  </div>

  <div class="accordion" id="formulariosAccordion">
    <div
      class="accordion-item"
      *ngFor="let formulario of formularios; let i = index"
    >
      <h2 class="accordion-header" [id]="'heading' + i">
        <button
          class="accordion-button collapsed"
          type="button"
          data-bs-toggle="collapse"
          [attr.data-bs-target]="'#collapse' + i"
          aria-expanded="false"
          [attr.aria-controls]="'collapse' + i"
        >
          {{ formulario.nombre }} — {{ formulario.descripcion }}
        </button>
      </h2>

      <div
        [id]="'collapse' + i"
        class="accordion-collapse collapse"
        [attr.aria-labelledby]="'heading' + i"
        data-bs-parent="#formulariosAccordion"
      >
        <div class="accordion-body">
          <p><strong>Usuario:</strong> {{ formulario.usuario }}</p>
          <p>
            <strong>Fecha de creación:</strong>
            {{ formulario.fechaCreacion | date : "short" }}
          </p>

          <div *ngIf="formulario.leads.length === 0" class="text-muted">
            Este formulario aún no tiene leads.
          </div>

          <div *ngIf="formulario.leads.length > 0" class="table-responsive">
            <table class="table table-sm table-bordered mt-3">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Fecha de envío</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let lead of formulario.leads; let j = index">
                  <td>{{ j + 1 }}</td>
                  <td>{{ lead.nombre }}</td>
                  <td>{{ lead.email }}</td>
                  <td>{{ lead.fechaEnvio | date : "short" }}</td>
                  <td>
                    <span
                      class="badge"
                      [ngClass]="{
                        'bg-success': lead.estado === 'ATENDIDO',
                        'bg-secondary': lead.estado === 'NUEVO',
                        'bg-danger': lead.estado === 'DESCARTADO',
                      }"
                    >
                      {{ lead.estado }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Botón para agregar un lead -->
          <button
            class="btn btn-success mt-3"
            (click)="abrirFormularioLead(formulario.id)"
          >
            Agregar Lead
          </button>

          <!-- Formulario para agregar un nuevo lead -->
          <div *ngIf="formulario.id === formularioSeleccionado" class="mt-3">
            <form (ngSubmit)="crearLead(formulario.id)" #leadForm="ngForm">
              <div class="mb-3">
                <label for="nombre" class="form-label">Nombre</label>
                <input
                  id="nombre"
                  type="text"
                  class="form-control"
                  [(ngModel)]="nuevoLead.nombre"
                  name="nombre"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input
                  id="email"
                  type="email"
                  class="form-control"
                  [(ngModel)]="nuevoLead.email"
                  name="email"
                  required
                />
              </div>

              <button
                class="btn btn-primary"
                type="submit"
                [disabled]="!leadForm.valid"
              >
                Crear Lead
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
